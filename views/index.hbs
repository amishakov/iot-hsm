<script>
    var slots = {{{slotstring}}}
    console.log(slots);
    window.onload = function() {
        let logos = document.getElementsByClassName('card-img-top');
        for(let i = 0; i <= logos.length - 1; i++) {
            //console.log(logos[i].alt);
            switch(logos[i].alt.split(' ')[0]) {
                case "SoftHSM":
                    logos[i].src = '/images/SoftHSM-logo.png';
                    break;
                case "YubiKey":
                    logos[i].src = '/images/yubikey-iot.png';
                    break;
                default:
                    logos[i].src = '';
            }
        }
    }

    function changeSlot(slotindex) {
        let selectedslot = document.getElementById('selectedslot' + slotindex);
        let slotinfo = document.getElementById('slotinfo' + slotindex);
        let selectedslotvalue = selectedslot.options[selectedslot.selectedIndex].value;

        //console.log(selectedslotvalue);
        if(selectedslotvalue=='false') {
            slotinfo.innerHTML = '<i>No slot selected</i>';
        } else {
            slotinfo.innerHTML = 'Name: ' + slots.slots[slotindex].objects[selectedslotvalue]['Certificate Object'][0].certinfo.subject.commonName[0] + '<br />\r\n\
            ID: ' + slots.slots[slotindex].objects[selectedslotvalue]['Certificate Object'][0].ID + '<br />\r\n\
            Status: Connected <br />\r\n\
            <div class="row">\r\n\
                <div class="col-6 test-left">\r\n\
                    <a href="#">View Certificate</a>\r\n\
                </div>\r\n\
                <div class="col-6 text-right">\r\n\
                    <a href="javascript: clearSlot(\'' + slots.slots[slotindex]['serial num'] + '\', \'' + selectedslotvalue + '\');" class="card-link">Clear Slot</a>\r\n\
                </div>\r\n\
            </div>';
        }
    }

    function clearSlot(serial, slotid) {
        var r = confirm("Are you sure you want to clear slot " + slotid + " in the token with serial " + serial + "?");
        if (r == true) {
            $('#overlay').fadeIn();
            postRequest('/api/pkcs11/clearslot', {
                serial: serial,
                objectid: slotid,
                }, function(err, resp) {
                if(err) {
                    alert(resp.message);
                    //console.log(response);
                } else {
                    waitForSlots(function(err, resp) {
                        $('#overlay').fadeOut();
                        if(err) {
                            alert(err);
                        } else {
                            //console.log(resp);
                            location.reload();
                        }
                    });
                }
            });
        }
    }

    function waitForSlots(callback) {
        getAPIRequest('/api/pkcs11/slotstatus', function(err, resp) {
            if(err) {
                callback(resp.message, resp);
                //console.log(response);
            } else {
                //$('#overlay').fadeOut();
                if(resp.data == 'initializing') {
                    setTimeout(function() {
                        waitForSlots(callback);
                    }, 1000);
                } else {
                    callback(false, resp);
                }
            }
        });
    }
</script>
<div style="margin-top: 20px;" class="container">
    <div class="row">
    {{#each slots.slots}}
        {{#if this.[serial num]}}
        <div class="col-sm-4 mx-auto">
            <div class="shadow-lg card" style="width: 25rem;">
                <img class="card-img-top" alt="{{this.[token model]}}">
                <div class="card-body">
                    <h5 class="card-title">{{this.[token model]}}</h5>
                    <h6>Serial: {{this.[serial num]}}</h6>
                    <h6>Token ID: {{this.hexid}}</h6>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <select onchange="changeSlot({{@index}});" id="selectedslot{{@index}}" class="form-control">
                            <option value="false">{{this.objects.length}} Configured Slots...</option>
                            {{#each this.objects}}
                            <option value="{{@key}}">Slot {{this.[Certificate Object].[0].ID}} - {{this.[Certificate Object].[0].certinfo.subject.commonName.[0]}}</option>
                            {{/each}}
                        </select>
                    </li>
                    <li style="height: 120px;" class="list-group-item" id="slotinfo{{@index}}"><i>No slot selected</i></li>
                    <li class="list-group-item">
                        <div class="row">
                            <div class="col-6 test-left">
                                <a href="/wizard/key/{{this.[serial num]}}" class="card-link">Configure Slot</a>
                            </div>
                            {{#ifEquals this.[token model] 'SoftHSM v2'}}
                            <div class="col-6 text-right">
                                <a href="#" class="card-link">Delete HSM</a>
                            </div>
                            {{/ifEquals}}
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        {{/if}}
    {{/each}}
    </div>
</div>
<div id="overlay" style="display:none;">
    <div class="spinner"></div>
    <br/>
    Processing...
</div>
<style>
    html, body {
    height: 100%;
}

/* CSS only for examples not required for centering */
.container {
    height: 100%;
}

h1 {
    text-align: center;
}

.note {
    position: absolute;
    z-index: 10;
    right: 0;
    top: 0;
    padding: 5px;
    background: #eee;
    max-width: 360px;
    border: 1px dotted #bbb;
}
</style>